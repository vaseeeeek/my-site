var WaLoginAbstractForm=function(t){var e=function(){},r=e;r.className="WaLoginAbstractForm",r.def=function(t,e){for(var r=0,o=arguments.length;r<o;r++)if(void 0!==arguments[r])return arguments[r]};var o=r.def;return r.inherit=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t},r.prototype.init=function(t){var e=this;e.initVars(t),e.initSubmit(),e.initErrorsAutoCleaner(),e.showErrors(e.errors),e.setFocus(),e.initCaptcha()},r.prototype.initVars=function(e){var n=this;e=e||{},n.$wrapper=o(n.$wrapper,e.$wrapper,t()),n.$form||(n.$form=n.$wrapper.find(".js-wa-form-item"),n.$form.length||(n.$form=n.$wrapper.find("form")),n.$form.length||(n.$form=t())),n.namespace=o(n.namespace,e.namespace,""),n.$templates=o(n.$templates,e.$templates,{}),n.$templates=t.extend({error_msg:t('<em class="wa-error-msg"></em>'),info_msg:t('<div class="wa-info-msg"></div>')},n.$templates),n.classes=o(n.classes,e.classes,{}),n.classes=t.extend({error_input:"wa-error",error_msg:"wa-error-msg",uncaught_errors:"wa-uncaught-errors",messages:"wa-info-messages",messages_wrapper:"wa-info-messages-wrapper",message_msg:"wa-info-msg",field:"field"},n.classes),n.errors=o(n.errors,e.errors,{}),n.locale=o(n.locale,e.locale,{}),n.js_validate=o(n.js_validate,e.js_validate,!0),n.is_json_mode=o(n.is_json_mode,e.is_json_mode),n.className=o(n.className,r.className),n.$captcha=o(n.$captcha,n.$wrapper.find(".wa-captcha-field")),n.need_redirects=void 0===e.need_redirects||!!e.need_redirects,n.env="",n.form_type=""},r.prototype.getFormItem=function(){return this.$form},r.prototype.getFormAction=function(){var t=this;return t.$form.is("form")?t.$form.attr("action"):t.$form.data("action")},r.prototype.getSerializedFormData=function(){var t=this,e=t.getFormItem();return e.is("form")?e.serializeArray():(e.find("[data-turn-off=1]").find(":input").attr("disabled",!0),e.find(":input:not(:disabled)").serializeArray())},r.prototype.beforeSubmit=function(){var t=this,e=t.getFormItem(),r=function(){var t=document.cookie.match(new RegExp("(?:^|; )_csrf=([^;]*)"));return t&&t[1]?decodeURIComponent(t[1]):""};e.find('[name="_csrf"]').val(r)},r.prototype.setFocus=function(){},r.prototype.triggerEvent=function(t){var e=this,r={env:e.env,form_type:e.form_type,form_wrapper_id:e.$wrapper.attr("id")},o=Array.prototype.slice.call(arguments),o=o.slice(1);e.$wrapper.trigger(t,o.concat([r]))},r.prototype.initCaptcha=function(){var e=this;e.$wrapper.find(".wa-captcha-field").length?t(window).one("wa_recaptcha_loaded wa_captcha_loaded",function(){e.triggerEvent("wa_auth_form_loaded"),e.triggerEvent("wa_auth_form_change_view")}):e.triggerEvent("wa_auth_form_loaded")},r.prototype.turnOffBlock=function(e){var r=this;e.data("turnOff",1).attr("data-turn-off",1).hide(),e.find(":input").attr("disabled",!0),e.find("[type=button],:submit").each(function(){var e=t(this),o=t('<div class="wa-js-old-button-place"></div>'),n=t('<div class="wa-js-new-button-place"></div>');e.after(o),o.data("button",e),n.hide(),r.getFormItem().append(n),n.html(e)}),r.triggerEvent("wa_auth_form_change_view")},r.prototype.turnOnBlock=function(e){var r=this;e.find(".wa-js-old-button-place").each(function(){var e=t(this),r=e.data("button"),o=r.parent();e.after(r),e.remove(),o.remove()}),e.data("turnOff","").attr("data-turn-off","").show(),e.find(":input").attr("disabled",!1),r.triggerEvent("wa_auth_form_change_view")},r.prototype.isJsonMode=function(){return this.is_json_mode},r.prototype.formatInfoMessage=function(e,r,o){r=void 0===r||r;var n=this,a=n.$templates.info_msg,i=a.clone();return void 0!==o&&i.data("name",o).attr("data-name",o),r?i.text(t.trim(""+e)):i.html(t.trim(""+e))},r.prototype.getInfoMessages=function(t){var e=this,r=e.$wrapper,o="."+e.classes.message_msg;return t&&(o+='[data-name="'+t+'"]'),r.find(o)},r.prototype.clearInfoMessages=function(t){var e=this;e.getInfoMessages(t).remove(),e.triggerEvent("wa_auth_form_change_view")},r.prototype.showInfoMessages=function(e){var r=this,o=r.$wrapper,n=o.find("."+r.classes.messages);t.each(e||{},function(e,o){var a=r.getFormInput(e);"string"==typeof o&&(o=[o]);var i=[];t.each(o||[],function(t,o){var n=r.formatInfoMessage(o,!1,e);n.data("code",t).attr("data-code",t),i.push(n)}),a.length?a.after(i):n.show().append(i)}),r.triggerEvent("wa_auth_form_change_view")},r.prototype.clearErrors=function(e){var r=this,o=r.$wrapper,n=o.find("."+r.classes.error_input),a=!1;n.removeClass(r.classes.error_input),a=a||n.length>0;var i=o.find("."+r.classes.error_msg);e||(i=i.not("[data-not-clear=1]")),a=a||i.length>0,i.each(function(){var e=t(this);"timeout"===e.data("name")&&e.data("timer")&&e.data("timer")&&"function"==typeof e.data("timer").finish&&e.data("timer").finish()}),i.remove(),o.find("."+r.classes.uncaught_errors).find("."+r.classes.error_msg).length<=0&&(o.find("."+r.classes.uncaught_errors).hide(),a=!0),a&&r.triggerEvent("wa_auth_form_change_view")},r.prototype.getErrorTemplate=function(t,e,r){return this.$templates.error_msg},r.prototype.escape=function(e){var r=t("<div>");return r.text(t.trim(""+e)),e=r.text(),r.remove(),e},r.prototype.prepareErrorText=function(t,e,r){return this.escape(e)},r.prototype.prepareErrorItem=function(t,e,r){var o=this,n=o.getErrorTemplate(t,e,r).clone(),a=n.clone();return a.data("name",t).data("code",r).attr("data-name",t).attr("data-code",r),a.html(o.prepareErrorText(t,e,r)),a},r.prototype.showInputError=function(t,e){var r=this,o=r.getFormInput(t);return!!o.length&&(o.parent().append(e),o.addClass(r.classes.error_input),!0)},r.prototype.getFormInput=function(t){var e=this,r=e.getFormItem(),o=e.buildFormInputName(t);return r.find('[name="'+o+'"]')},r.prototype.buildFormInputName=function(t){var e=this,r=e.namespace;return r?r+"["+t+"]":t},r.prototype.getFormField=function(t){var e=this;return e.$wrapper.find("."+e.classes.field+'[data-field-id="'+t+'"]')},r.prototype.getInfoMessageItem=function(t,e){var r=this,o=r.$wrapper,n=o.find("."+r.classes.message_msg+'[data-name="'+t+'"]');return void 0!==e?n.filter('[data-code="'+e+'"]'):n},r.prototype.getErrorItem=function(t,e){var r=this,o=r.$wrapper,n=o.find("."+r.classes.error_msg+'[data-name="'+t+'"]');return void 0!==e?n.filter('[data-code="'+e+'"]'):n},r.prototype.showUncaughtErrors=function(t,e,r){var o=this,n=o.$wrapper,a=n.find("."+o.classes.uncaught_errors);return!!a.length&&(a.show(),r&&a.html(""),a.show().append(e),!0)},r.prototype.afterShowErrors=function(){},r.prototype.showErrors=function(e){var r=this;t.each(e||{},function(e,o){"string"==typeof o&&(o=[o]);var n=r.prepareErrorItems(e,o),a=r.showInputError(e,n);a||(a=r.showUncaughtErrors(e,n,!0)),!a&&console&&console.error&&t.each(n,function(){var e="Uncaught validate error: "+t(this).text();console.error(e)})}),r.afterShowErrors(),r.triggerEvent("wa_auth_form_change_view")},r.prototype.initSubmit=function(){var e=this,r=e.getFormItem(),o=null,n=function(t){var r=e.onSubmit(t);r&&(o&&o.abort(),o=r)};r.is("form")?r.submit(function(t){n(t)}):(r.on("click",":submit,button",function(e){var r=t(this);r.is(":disabled")||r.data("ignore")||(e.preventDefault(),n(e))}),r.on("keydown","input",function(t){13==t.keyCode&&(t.preventDefault(),r.find(":submit,button").not(":disabled").filter(":first").trigger("click"))}))},r.prototype.validate=function(){return{}},r.prototype.initErrorsAutoCleaner=function(){var e=this,r=e.getFormItem(),o={},n=e.buildFormInputName("captcha"),a=":text:not([name="+n+"]),:password";r.find(a).each(function(){var e=t(this),r=e.attr("name"),n=e.val();o[r]={val:t.trim(n||""),timer:null}}),r.on("keydown",a,function(r){if(13!=r.keyCode){var n=t(this),a=n.attr("name"),i=o[a]||{},s=t.trim(i.val||""),p=i.timer||null;p&&clearTimeout(p),i.timer=setTimeout(function(){var r=t.trim(n.val()||"");r!==s&&e.clearErrors(),i.val=r},300)}}),r.on("change",":input",function(){var r=t(this),n=r.attr("name"),a=o[n]||{},i=t.trim(a.val||""),s=t.trim(r.val()||"");s!==i&&e.clearErrors(),a.val=s})},r.prototype.onDoneSubmitHandlers=function(){var t=this;return{errors:function(e,r){return t.showErrors(e),!0},redirect:function(t){return t=t||"",-1!==t.indexOf("#")&&t===window.location.href?window.location.reload():window.location.href=t,!0},messages:function(e){return t.showInfoMessages(e),!0},rest:function(t){return!0}}},r.prototype.onDoneSubmit=function(e){var r=this,o=r.onDoneSubmitHandlers(),n=e&&"ok"===e.status,a=e&&e.data||{},i=a.messages||{},s=e&&e.errors||{};if(n||!(o.errors&&o.errors(s,e))){if(r.isRedirectResponse(e)){var p=r.getRedirectUrl(e);if(o.redirect&&o.redirect(p,e))return}!t.isEmptyObject(i)&&(o.messages&&o.messages(i,e))||o.rest&&o.rest(e)}},r.prototype.submit=function(e){e=e||{};var r=this;if(r.beforeSubmit(),r.clearErrors(!0),r.js_validate){var o=r.validate();if(!t.isEmptyObject(o))return void r.showErrors(o)}var n=r.getFormItem(),a=e.$button||n.find(":submit"),i=e.$loading||n.find(".wa-loading"),s=e.url||r.getFormAction(),p=r.getSerializedFormData();return i.show(),a.attr("disabled",!0),r.jsonPost(s,p).done(function(t){r.isRedirectResponse(t)||(a.attr("disabled",!1),i.hide()),r.onDoneSubmit(t)}).fail(function(){a.attr("disabled",!1)})},r.prototype.onSubmit=function(t){var e=this;if(e.isJsonMode())return t.preventDefault(),e.submit()},r.prototype.mixinVarsInData=function(e,r){return t.isPlainObject(r)?r=t.extend(r,e):t.isArray(r)?t.each(e,function(t,e){r.push({name:t,value:e})}):r&&t.each(e,function(t,e){r+="&"+t+"="+e}),r},r.prototype.beforeJsonPost=function(t,e){var r=this,o={wa_json_mode:1,need_redirects:r.need_redirects?1:0};return e=r.mixinVarsInData(o,e)},r.prototype.isRedirectResponse=function(t){return null!==this.getRedirectUrl(t)},r.prototype.getRedirectUrl=function(t){var e=t&&"ok"===t.status&&t.data&&t.data.redirect_url;return"string"==typeof e?e:null},r.prototype.jsonPost=function(e,r){var o=this;return r=o.beforeJsonPost(e,r),t.post(e,r,"json").always(function(e){o.isRedirectResponse(e)||t(".wa-captcha-refresh").trigger("click")})},r.prototype.beforeErrorTimerStart=function(t,e,r){},r.prototype.afterErrorTimerFinish=function(t,e,r){},r.prototype.prepareTimeoutErrorItem=function(t,e,r){var o=this,n=o.prepareErrorItem("timeout",t);return r=r||{},o.beforeErrorTimerStart(t,e,r),n.data("notClear",1).attr("data-not-clear",1),o.runTimeoutMessage(n,{timeout:e,onFinish:function(){n.remove(),o.afterErrorTimerFinish(t,e,r)}}),n},r.prototype.prepareErrorItems=function(e,r){var o=this,n=[];if("timeout"===e){var a=r.message,i=r.timeout,s=o.prepareTimeoutErrorItem(a,i,{error_namespace:e});n=[s]}else t.each(r||[],function(t,r){var a;a="timeout"===t?o.prepareTimeoutErrorItem(r.message,r.timeout,{error_namespace:e,error_code:t}):o.prepareErrorItem(e,r,t),n.push(a)});return n},r.prototype.runTimeoutMessage=function(e,r){var o=this,n=r.timeout,a=t.trim(e.html()),i=r.onFinish,s=null;if(n=parseInt(n,10),n=!isNaN(n)&&n>0?n:60,i="function"==typeof i?i:null,a.match(/\d+:\d/)){o.triggerEvent("wa_auth_form_change_view");var p=function(){s&&clearInterval(s),e.remove(),i&&i()};s=setInterval(function(){if((n-=1)<=0)return void p();var t=e.html(),r=parseInt(n/60,10),o=n%60,a=r<=9?"0"+r:r,i=o<=9?"0"+o:o;t=t.replace(/\d+:\d+/,a+":"+i),e.html(t)},1e3);var u={finish:p};return e.data("timer",u),u}},r}(jQuery),WaLoginAbstractLoginForm=function(t){var e=WaLoginAbstractLoginForm=function(){};e.className="WaLoginAbstractLoginForm";var r=WaLoginAbstractForm,o=WaLoginAbstractForm.def;return e.prototype=Object.create(r.prototype),e.prototype.constructor=e,e.prototype.init=function(t){var e=this;r.prototype.init.call(e,t)},e.prototype.initVars=function(t){var n=this;t=t||{},n.auth_type=o(n.auth_type,t.auth_type,""),n.className=o(n.className,e.className),r.prototype.initVars.call(n,t),n.timeout=o(n.timeout,0),n.timeout=isNaN(n.timeout)||n.timeout<=0?60:n.timeout,n.form_type="login"},e.prototype.setFocus=function(){var e=this,r=e.getFormInput("login"),o=e.getFormInput("password");t.trim(r.val()||"")?o.focus():r.focus()},e.prototype.validate=function(e){var r=this,o=r.getSerializedFormData(),n={};return t.each(o,function(o,a){var i=a.name,s=t.trim(a.value||"");i!==r.buildFormInputName("login")||s||(n.login=[r.locale.login_required||r.locale.required||""]),i!==r.buildFormInputName("captcha")||s||(n.captcha=[r.locale.captcha_required||r.locale.required||""]),e||i!==r.buildFormInputName("password")||s||(n.password=[r.locale.password_required||r.locale.required||""])}),n},e.prototype.prepareErrorItem=function(t,e,o){var n=this,a=r.prototype.prepareErrorItem.call(n,t,e,o);if(n.isOneTimePasswordMode()&&"password"===t&&"out_of_tries"===o){var i=n.getFormInput("password"),s=n.getFormItem();i.attr("readonly",!0),s.find(".wa-login-submit").attr("disabled",!0)}return a},e.prototype.isOneTimePasswordMode=function(){return"onetime_password"===this.auth_type},e.prototype.onSentOnetimePassword=function(t){var e=this;t=t||{},e.showInfoMessages(t.messages||{})},e.prototype.initOnetimePasswordLink=function(e){var r=this,e=e||{},o=e.$link,n=e.$loading;if(o.length&&r.isOneTimePasswordMode()){var a=null;o.data("ignore","1"),o.on("click",function(e){if(e.preventDefault(),r.clearErrors(),r.js_validate){var i=r.validate(!0);if(!t.isEmptyObject(i))return void r.showErrors(i)}if(!a){var s=o.attr("href")||o.data("href");n.show(),o.attr("disabled",!0);var p=r.getSerializedFormData();r.clearErrors(),a=r.jsonPost(s,p).done(function(t){o.attr("disabled",!1),t&&"ok"===t.status?r.onSentOnetimePassword(t.data):r.showErrors(t?t.errors||{}:{})}).fail(function(){o.attr("disabled",!1)}).always(function(){a=null,n.hide()})}})}},e}(jQuery),WaBackendLogin=function(t){var e=function(t){this.init(t)},r=e;r.className="WaBackendLogin";var o=WaLoginAbstractLoginForm;return WaLoginAbstractForm.inherit(r,o),r.prototype.init=function(t){var e=this;o.prototype.init.call(e,t),e.initCancelButton(),e.initOnetimePasswordLink({$link:e.$wrapper.find(".wa-request-onetime-password-button"),$loading:e.$wrapper.find(".wa-request-onetime-password-button-loading")}),e.initOnetimePasswordLink({$link:e.$wrapper.find(".wa-request-onetime-password-link"),$loading:e.$wrapper.find(".wa-request-onetime-password-link-loading")}),e.webasyst_id_auth_url&&(e.initWebasystIDAuthLink(),e.initWebasystIDHelpLink()),e.bind_with_webasyst_contact&&(e.initSignInAndBindWithWebasystID(),e.initWebasystIDHelpLink())},r.prototype.initCancelButton=function(){var t=this,e=t.getFormItem();e.find(".wa-login-cancel").on("click",function(r){r.preventDefault(),t.is_json_mode=!1,e.append('<input type="hidden" name="cancel" value="1" />'),e.submit()})},r.prototype.initVars=function(t){var e=this;e.className=r.className,o.prototype.initVars.call(e,t),e.$wrapper.data("WaAuthForm",e),e.is_json_mode=!0,e.env="backend",e.wa_app_url=t.wa_app_url||"",e.webasyst_id_auth_url=t.webasyst_id_auth_url||"",e.bind_with_webasyst_contact=t.bind_with_webasyst_contact||!1},r.prototype.setupOnetimePasswordView=function(){var t=this,e=t.$wrapper,r=t.getFormField("password");t.makeInputReadonly("login",!1),t.turnOffBlock(r),t.turnOffBlock(e.find(".wa-submit-button-wrapper")),t.turnOnBlock(e.find(".wa-request-onetime-password-button-wrapper")),t.turnOffBlock(e.find(".field-remember-me")),e.find(".wa-change-login-link").hide(),e.find(".wa-request-onetime-password-link-wrapper").hide(),r.find("."+t.classes.message_msg).remove(),t.triggerEvent("wa_auth_form_change_view")},r.prototype.onSentOnetimePassword=function(t){t=t||{};var e=this,r=e.$wrapper,o=e.getFormField("password"),n=e.getFormInput("password");e.makeInputReadonly("login"),e.turnOnBlock(o),n.removeAttr("readonly").val(""),e.turnOnBlock(r.find(".wa-submit-button-wrapper")),e.turnOffBlock(r.find(".wa-request-onetime-password-button-wrapper")),e.turnOnBlock(r.find(".field-remember-me")),e.initChangeLoginLink(),e.clearInfoMessages("password"),e.showInfoMessages({password:{timeout:t.onetime_password_timeout_message,sent_message:t.onetime_password_sent_message}}),r.find(".wa-change-login-link").hide(),r.find(".wa-request-onetime-password-link-wrapper").hide();var a=e.getInfoMessageItem("password","timeout");e.runTimeoutMessage(a,{timeout:t.onetime_password_timeout,onFinish:function(){r.find(".wa-change-login-link").show(),r.find(".wa-request-onetime-password-link-wrapper").show(),a.remove()}})},r.prototype.initChangeLoginLink=function(){var t=this;t.$wrapper.find(".wa-change-login-link").one("click",function(){t.setupOnetimePasswordView()})},r.prototype.makeInputReadonly=function(e,r){r=void 0===r||!!r;var o=this,n=o.getFormInput(e);if(n.attr("disabled",r),r){var a=n.attr("name"),i=n.val(),s=t('<input type="hidden">').attr("name",a).val(i);s.insertAfter(n),n.data("hidden_clone",s)}else{var s=n.data("hidden_clone");s.length&&s.remove()}},r.prototype.onDoneSubmitHandlers=function(){var t=this,e=o.prototype.onDoneSubmitHandlers.call(t);return e.redirect=function(t){var e=window.location.href||"",r=0===e.indexOf(t),o=-1!==e.indexOf("#");r&&o?window.location.reload():window.location.href=t},e},r.prototype.initWebasystIDAuthLink=function(e){var r=this,o=r.$wrapper,n=o.find(".js-webasyst-auth-link"),a=o.find(".field-remember-me"),i=a.find(":checkbox");n.on("click",function(r){r.preventDefault();var o=t(this).attr("href")||"";if(i.is(":checked")&&(o=o.replace("backend_auth=1","backend_auth=2")),!e)return void(window.location=o);var n=(screen.width-600)/2,a=(screen.height-500)/2;window.open(o,"oauth","width=600,height=500,left="+n+",top="+a+",status=no,toolbar=no,menubar=no")})},r.prototype.initSignInAndBindWithWebasystID=function(){var e=this;t(".js-back-to-simple-login").on("click",function(r){r.preventDefault(),t.post(e.wa_app_url+"?module=login&action=reset",function(){window.location.reload()})})},r.prototype.initWebasystIDHelpLink=function(){var e=this;e.$wrapper.find(".js-waid-hint").on("click",function(r){r.preventDefault();var o=e.wa_app_url+"?module=backend&action=webasystIDHelp";t.get(o,function(e){t("body").append(e)})})},r}(jQuery);
//# sourceMappingURL=login-backend-form.min.js.map
